> 之前很少会需要修改防火墙，也一直懒得系统学习一下，尤其在 VPS 配置安全组时，只能照着教程改，但并不明白啥意思，总归还是太菜和太懒！最近接触 zabbix ，看来不得不学习一下了

# 防火墙学习笔记

## SELinux、Netfilter、iptables、firewall 和 ufw五者关系

1. SELinux ( Security-Enhanced Linux，安全增强式 Linux ) 是一个 Linux 内核的安全模块，其提供了访问控制安全策略机制
2. netfilter 是 Linux 内核中的一个软件框架，用于管理网络数据包。不仅具有网络地址转换（ NAT ）的功能，也具备数据包内容修改、以及数据包过滤等防火墙功能。利用运作于用户空间的应用软件，如 iptables、ebtables 和 arptables 等，来控制 netfilter，系统管理者可以管理通过 Linux 操作系统的各种网络数据包
3. iptables 是一个命令行工具，用来配置 netfilter 防火墙
4. firewall 是 centos7+、RHEL7+、Fedora 里面新的防火墙管理命令
5. ufw 是 Ubuntu 下的一个简易的防火墙配置工具


> * SELinux 是美国国家安全局 (NSA ) 对于强制访问控制的实现，是 Linux 历史上最杰出的新安全子系统，它不是用来防火墙设置的，但它对 Linux 系统的安全很有用。Linux 内核 ( Kernel ) 从 2.6 就有了SELinux
> * ufw、firewall 其实都是对 iptables 的封装，底层执行的都是 iptables 命令；iptables 调用内核模块 netfilter 实施真正的操作


## SELinux

* **很多教程安装配置的时候一上来就让我们关了 SELinux，知乎回答**
  * SELinux 策略是白名单原则，所以你需要非常清楚你的各项操作都需要哪些访问权限，这个好像数量有点多了
  * 不外乎不懂怎么用，关了一了百了，懂怎么用的不想折腾，还是关了一了百了
  * 因为它在本来已经很安全的 Linux 上，凌驾于 root 权限之上，设置了很多额外的条条框框；如果你了解这些条条框框，那还好；但如果不了解，那 SELinux 可能并没有帮什么忙，却给你带来了很多不确定因素
  
#### 常用命令

``` shell
# 查看 SELinux 是否运行
getenforce                # disabled：表示 selinux 关闭，没有启动；其他两种 ( enforcing、permissive ) 均表示 selinux 启动了，只是运行的模式不一样

# 关闭SELinux

# 临时生效，重启机器后失效
# 命令临时生效：
setenforce 0 
#            1 启用
#           0 告警，不启用

# 永久生效
# 操作前先备份
cp /etc/selinux/config /etc/selinux/config.bak
# 更改 setlinux 级别
sed -i 's/SELINUX=enforcing/\SELINUX=disabled/' /etc/selinux/config
 # 或 
vim /etc/selinux/config
# 修改SELINUX=disabled
# 使用配置生效
reboot 
# 或
setenforce 0        #使配置立即生效
```

## netfilter

* netfilter 是 Linux 操作系统核心层内部的一个数据包处理模块
## iptables

* 在 Linux 生态系统中，iptables 是使 用很广泛的防火墙工具之一，它基于内核的包过滤框架（packet filtering framework） netfilter
* iptables 是运行在用户态的一个程序，通过 netlink 和内核的 netfilter 框架打交道
* iptables 是 Linux 下功能强大的应用层防火墙工具, 说到 iptables 必然提到Netfilter，iptables 是应用层的，其实质是一个定义规则的配置工具，而核心的数据包拦截和转发是 Netfiler

#### 常用命令

```shell
# 查看防火墙状态：
service iptables status
# 关闭防火墙（永久性,重启机器后也会保持生效)
chkconfig iptables off
# 开启防火墙 (永久性,重启机器后也会保持生效）
chkconfig iptables on
# 临时关闭防火墙（重启机器后失效)
service iptables off
# 临时开启防火墙（重启机器后失效)
service iptables on
```

**[iptables 深度详解](https://liqiang.io/post/dive-in-iptables)**


## firewall

> * firewall 的底层是使用 iptables 进行数据过滤，建立在 iptables 之上
> * firewall 是动态防火墙，使用了 D-BUS 方式，修改配置不会破坏已有的数据链接

### firewalld

* firewalld - Dynamic Firewall Manager

#### 常用命令

``` shell
# 启动防火墙
systemctl start firewalld.service
# 停止防火墙/关闭防火墙
systemctl stop firewalld.service
# 重启防火墙
systemctl restart firewalld.service
# 设置开机启用防火墙
systemctl enable firewalld.service
# 设置开机不启动防火墙
systemctl disable firewalld.service
```

#### 配置

* firewalld 的配置文件是以 xml 的格式，存储在 `/usr/lib/firewalld/` 和 `/etc/firewalld/` 目录中


### firewall-cmd

* firewall - cmd is the command line client of the firewalld daemon. It provides interface to manage runtime and permanent configuration.


#### 常用命令

``` shell
# 查看 firewall 状态
firewall-cmd --state
# 新增开放端口号
firewall-cmd [--zone=<zone>] --add-port=<port>[-<port>]/<protocol> [--timeout=<seconds>] [--permanent]
# 例如：
firewall-cmd --zone=public --add-port=80/tcp --permanent
#说明:
# --zone 作用域
#            阻塞区域（block）：任何传入的网络数据包都将被阻止。
#            工作区域（work）：相信网络上的其他计算机，不会损害你的计算机。
#            家庭区域（home）：相信网络上的其他计算机，不会损害你的计算机。
#            公共区域（public）：不相信网络上的任何计算机，只有选择接受传入的网络连接。
#            隔离区域（DMZ）：隔离区域也称为非军事区域，内外网络之间增加的一层网络，起到缓冲作用。对于隔离区域，只有选择接受传入的网络连接。
#            信任区域（trusted）：所有的网络连接都可以接受。
#            丢弃区域（drop）：任何传入的网络连接都被拒绝。
#            内部区域（internal）：信任网络上的其他计算机，不会损害你的计算机。只有选择接受传入的网络连接。
#            外部区域（external）：不相信网络上的其他计算机，不会损害你的计算机。只有选择接受传入的网络连接。
# --add-port=80/tcp 添加端口，格式为：端口或端口范围/协议(udp/tcp)
# --permanent 永久生效，没有此参数重启后失效
# 查看
firewall-cmd --zone=public --query-port=80/tcp
# 删除
firewall-cmd --zone=public --remove-port=80/tcp --permanent
# 重新载入，每次执行完 firewall-cmd 都应该 reload 一次
firewall-cmd --reload

```
